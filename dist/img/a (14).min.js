//默认弹出层注册送188，用户点击关闭或已经登录不弹出,默认15天有效期过
(function (window) {

    var _device = (window.location.href.indexOf('m.mia.com') > -1 || window.location.href.indexOf('m.miyabaobei.com') > -1) ? 'app' : 'pc';

    //物料地址
    var sImgPc;
    var sImgApp;
    var sImgPcKaTiao;
    var pop_link = '/app.html';
    var katiao_link = '/app.html';
    if (typeof (pc_pop) != 'undefined') {
        if (pc_pop.img != '') {
            sImgPc = pc_pop.img;
            if (pc_pop.url) {
                pop_link = pc_pop.url;
            }
        }

    }
    if (typeof (pc_bottom) != 'undefined') {
        if (pc_bottom.img != '') {
            sImgPcKaTiao = pc_bottom.img;
            if (pc_bottom.url) {
                katiao_link = pc_bottom.url;
            }
        }
    }

    if (typeof (m_pop) != 'undefined') {
        if (m_pop.img != '') {
            sImgApp = m_pop.img;
        }
    }

    var pupop = function ($btn) {
        this.$btn = $btn || '';
        if (_device == 'app') {
            this.pop = $('<div id="bi-middle" class="app_down" style="display:none;width:100%;position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);-webkit-transform:translate(-50%,-50%);z-index:1010;text-align:center;max-width:640px;"><img _src="' + sImgApp + '" width="90%" alt=""><a  style="position:absolute;top:0;left:0;width:100%;height:100%;" href="javascript:;" class="btn mia-downApp" id="down_app"></a><a href="javascript:;" style="display:block;width:15%;height:20%;position:absolute;right:0.5rem;top:0rem;" id="close_ldy_tc"></a></div>').appendTo(document.body);
            this.mask = $('<div class="mask" style="display:none;width:100%;height:100%;top:0px;left:0px; position:fixed;background:rgba(0,0,0,.7);z-index:1005;"></div>').appendTo(document.body);
        } else {
            this.pop = $('<div class="popimg" style="display:none;width:750px;height:548px;left:50%;top:50%;margin:-274px 0 0 -375px; background:url(' + sImgPc + ') no-repeat;position:fixed;z-index:1005;"><a style="display:block;width:100%;height:100%;position:absolute;top:0;left:0;background:url(about:blank)" href="' + pop_link + '" target="_blank" id="regist_ldy_tc"></a><a href="javascript:;" style="display:block;width:190px;height:110px;position:absolute;right:0;top:0;background:url(about:blank)" id="close_ldy_tc"></a></div>').appendTo(document.body);
            this.mask = $('<div class="mask" style="display:none;width:100%;height:100%;top:0px;left:0px;position:fixed;filter:Alpha(opacity=60);-moz-opacity: 0.6;opacity:0.6;background:#000000;z-index:1000;"></div>').appendTo(document.body);
            this.katiao = $('<div style="display:none;height:120px;width:100%;position:fixed;left:0;bottom:0;background:#000;opacity: 0.65;filter:alpha(opacity=50);z-index:100"></div><div id="pcKatiao" style="display:none;position:fixed;bottom:0;left:50%;margin-left:-500px;width:1000px;height:122px;z-index:102;background:url(' + sImgPcKaTiao + ') center top no-repeat;"><a style="display:block;width:41px;height:41px;position:absolute;left:50%;margin-left: 459px;top:2px;background: url(about:blank);" href="javascript:;" class="katiao_close"></a><a style="display:block;width:940px;height:100px;position:absolute;top:20px;left:50%;margin-left:-490px;background:url(about:blank)" href="' + katiao_link + '" target="_blank" id="regist_katiao"></a></div>').appendTo(document.body);
        }
        this.init();
    };

    pupop.prototype = {
        init: function () {
            var that = this;
            var isNewUser = getcookie('username');
            var display = getcookie('display');
            var kt_display = getcookie('display_katiao');
            var sFrom = getcookie('sitefrom');
            var ua = navigator.userAgent.toLowerCase();
            if (!isNewUser) {
                if (!display) {
                    if (!isApp() && !isWeiXin()) { //非微信 and 非app显示
                        that.show();
                        that.switchSrc(this.pop);
                    }
                } else {
                    if (_device == 'pc' && !kt_display) {
                        this.getImg();
                        this.katiao.show();
                    };
                }
            }
            $('#close_ldy_tc,#close_app').on('click', function () {
                var date = new Date();
                date.setTime(date.getTime() + 15 * 24 * 3600 * 1000);
                setcookie("display", '1', date.toGMTString());
                that.hide();
            });
            $('#regist_ldy_tc').on('click', function () {
                var prevhref = window.location.href;
                var date = new Date();
                setcookie("display", '1', date.toGMTString());
                // window.location.href = 'http://www.mia.com/register?url=' + encodeURIComponent(prevhref);
            });
            if (_device == 'app') {
                //ajax获取链接在 sem.js 内
            };
            $('#down_app, #bi-middle #down_app').on('click', function () {
                var date = new Date();
                setcookie("display", '1', date.toGMTString());
            });
            $('#regist_katiao').on('click', function () {
                var prevhref = window.location.href;
                setcookie("display_katiao", '1');
                // window.location.href = 'http://www.mia.com/register?url=' + encodeURIComponent(prevhref);
            });
            $('.katiao_close').on('click', function () {
                that.katiao.hide();
                setcookie("display_katiao", '1');
            });

        },
        show: function () {
            var _this = this;
            this.pop.css('display', 'block');
            this.mask.css('display', 'block');
            $('body').on('touchmove', function () {
                _this.stop()
            });
            // document.body.addEventListener('touchmove', _this.stop, false);
        },
        hide: function () {
            var _this = this;
            this.pop.hide();
            this.mask.hide();
            $('body').off('touchmove', function () {
                _this.stop()
            });
            // document.body.removeEventListener('touchmove', _this.stop, false);
        },
        getImg: function () {
            //获取pc底部卡条的二维码图片
            var sitefrom = getcookie('sitefrom');
            if (sitefrom) {
                $img = '<img class="getCodeImgForQudao" style="position:absolute;right:68px;top:19px;width:68px;height:68px;" onerror="//img.miyabaobei.com/d1/p2/2016/03/04/07/69/07690eb184b5a00125aad7da14861ee5.png" src="/instant/qrcode/index/"' + sitefrom + '"/>';
            } else {
                $img = '<img class="getCodeImgForQudao" style="position:absolute;right:68px;top:19px;width:68px;height:68px;" src="//img.miyabaobei.com/d1/p2/2016/03/04/07/69/07690eb184b5a00125aad7da14861ee5.png"/>';
            }
            $('#pcKatiao').prepend($img);
        },
        stop: function (event) {
            event.preventDefault();
        },
        switchSrc: function (ele) {
            var oImg = ele.find('img');
            var _src = oImg.attr('_src');
            oImg.attr('src', _src);
        }
    };
    //window.ldy_pupop = pupop;
    new pupop();
    if (typeof (pc_pop) != 'undefined') {
        if (pc_pop.img == '' || typeof(pc_pop.img) == 'undefined') {
            $('.mask,.popimg').hide();
        }

    }
    if (typeof (m_pop) != 'undefined') {
        if (m_pop.img == '' || typeof (m_pop.img) == 'undefined') {
            $('.mask,.app_down').hide();
        }
    }

    function isApp() {
        var href = window.location.href;
        var re = href.indexOf('_app');
        if (navigator.userAgent.indexOf('miyabaobei_') > -1 || re !== -1) {
            return true;
        }
        return false;
    }

    function isWeiXin() {
        var ua = window.navigator.userAgent.toLowerCase();
        if (ua.match(/MicroMessenger/i) == 'micromessenger') {
            return true;
        } else {
            return false;
        }
    }

})(this);